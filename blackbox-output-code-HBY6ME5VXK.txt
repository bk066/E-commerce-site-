const API_BASE = 'http://localhost:3000';

// Utility: Get JWT token from localStorage
function getToken() {
  return localStorage.getItem('token');
}

// Utility: Set JWT token
function setToken(token) {
  localStorage.setItem('token', token);
}

// Utility: Remove JWT token
function removeToken() {
  localStorage.removeItem('token');
}

// Fetch products and render on products.html
async function loadProducts() {
  try {
    const res = await fetch(`${API_BASE}/products`);
    const products = await res.json();
    const container = document.getElementById('product-list');
    container.innerHTML = '';

    products.forEach(product => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${product.image_url}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>Rs. ${product.price.toFixed(2)}</p>
        <button onclick="addToCart(${product.id})">Add to Cart</button>
      `;
      container.appendChild(card);
    });
  } catch (error) {
    console.error('Error loading products:', error);
  }
}

// Add product to cart
async function addToCart(productId) {
  const quantity = 1; // default quantity
  const token = getToken();
  if (!token) {
    alert('Please login to add items to cart.');
    window.location.href = 'login.html';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/cart`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ product_id: productId, quantity })
    });
    const data = await res.json();
    if (res.ok) {
      alert('Item added to cart');
    } else {
      alert(data.error || 'Failed to add to cart');
    }
  } catch (error) {
    console.error('Error adding to cart:', error);
  }
}

// Load cart items and render on cart.html
async function loadCart() {
  const token = getToken();
  if (!token) {
    alert('Please login to view cart.');
    window.location.href = 'login.html';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/cart`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const cartItems = await res.json();

    const container = document.getElementById('cart-items');
    container.innerHTML =